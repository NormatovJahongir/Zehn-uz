import { NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();
const TOKEN = process.env.NEXT_PUBLIC_TELEGRAM_BOT_TOKEN;
const WEB_APP_URL = "https://edu-market.onrender.com";

// Telegram API ga so'rov yuborish uchun yordamchi funksiya
async function tg(method: string, body: object) {
  return fetch(`https://api.telegram.org/bot${TOKEN}/${method}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
}

export async function POST(request: Request) {
  try {
    const payload = await request.json();
    
    // Agar bu oddiy xabar bo'lmasa, o'tkazib yuboramiz
    if (!payload.message) return NextResponse.json({ ok: true });

    const chatId = payload.message.chat.id;
    const text = payload.message.text;
    const userId = payload.message.from.id.toString();

    // 1. Foydalanuvchini bazadan tekshirish
    const dbUser = await prisma.user.findUnique({
      where: { telegramId: userId }
    });

    // 2. Start buyrug'i va mantiq
    if (text === '/start') {
      if (dbUser) {
        // Agar foydalanuvchi allaqachon bo'lsa
        const welcome = {
          uz: `Xush kelibsiz, ${dbUser.firstName}! Saytga kirish uchun quyidagi tugmani bosing:`,
          ru: `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${dbUser.firstName}! –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:`,
          en: `Welcome, ${dbUser.firstName}! Click the button below:`
        };
        
        await tg('sendMessage', {
          chat_id: chatId,
          text: welcome[dbUser.role === 'ADMIN' ? 'uz' : 'uz'], // Tilni bazadan olish mumkin
          reply_markup: {
            inline_keyboard: [[
              { text: "üåê Saytga kirish", web_app: { url: WEB_APP_URL } }
            ]]
          }
        });
      } else {
        // Agar foydalanuvchi yangi bo'lsa
        await tg('sendMessage', {
          chat_id: chatId,
          text: "Assalomu alaykum! Edu Market botiga xush kelibsiz.\nRo'yxatdan o'tish uchun Web App-ga kiring:",
          reply_markup: {
            inline_keyboard: [[
              { text: "üìù Ro'yxatdan o'tish", web_app: { url: `${WEB_APP_URL}/register` } }
            ]]
          }
        });
      }
    }

    return NextResponse.json({ ok: true });
  } catch (error) {
    console.error("Bot API Error:", error);
    return NextResponse.json({ error: "Internal Error" }, { status: 500 });
  }
}